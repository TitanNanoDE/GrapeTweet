<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<title>GrapeTweet Source: src/js/storage.js</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.default.css">

	<link type="text/css" rel="stylesheet" href="styles/site.paper.css">

</head>

<body>

<div class="navbar navbar-default navbar-fixed-top navbar-inverse">
<div class="container">
	<div class="navbar-header">
		<a class="navbar-brand" href="index.html">GrapeTweet</a>
	</div>
	<div class="navbar-collapse">
		<ul class="nav navbar-nav">
			
			<li class="dropdown">
				<a href="namespaces.list.html" class="dropdown-toggle" data-toggle="dropdown">Namespaces<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="external-af.connections.html">external:af.connections</a></li><li><a href="GrapeTweet.html">GrapeTweet</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="modules.list.html" class="dropdown-toggle" data-toggle="dropdown">Modules<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="GrapeTweet.module_Audio.html">GrapeTweet.Audio</a></li><li><a href="GrapeTweet.module_Bindings.html">GrapeTweet.Bindings</a></li><li><a href="GrapeTweet.module_Cache.html">GrapeTweet.Cache</a></li><li><a href="GrapeTweet.module_Gestures.html">GrapeTweet.Gestures</a></li><li><a href="GrapeTweet.module_Initializer.html">GrapeTweet.Initializer</a></li><li><a href="GrapeTweet.module_Misc.html">GrapeTweet.Misc</a></li><li><a href="GrapeTweet.module_Net.html">GrapeTweet.Net</a></li><li><a href="GrapeTweet.module_Storage.html">GrapeTweet.Storage</a></li><li><a href="GrapeTweet.module_UI.html">GrapeTweet.UI</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="classes.list.html" class="dropdown-toggle" data-toggle="dropdown">Classes<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="Conversation.html">Conversation</a></li><li><a href="GrapeTweet.module_Initializer-Catalog.html">GrapeTweet.Initializer~Catalog</a></li><li><a href="GrapeTweet.module_Initializer-TailTip.html">GrapeTweet.Initializer~TailTip</a></li><li><a href="Promise.html">Promise</a></li><li><a href="Timeline.html">Timeline</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="global.html" class="dropdown-toggle" data-toggle="dropdown">Global<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="global.html">Global</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="externals.list.html" class="dropdown-toggle" data-toggle="dropdown">Externals<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="external-af.html">af</a></li>
				</ul>
			</li>
			
		</ul>
	</div>
</div>
</div>


<div class="container">
<div class="row">

	
	<div class="col-md-12">
	
		<div id="main">
			

		<h1 class="page-title">Source: src/js/storage.js</h1>
    
<section>
	<article>
		<pre
			class="sunlight-highlight-javascript linenums">/**
 * @module Storage
 * @author Jovan Gerodetti &lt;jovan@titannano.de>
 * @copyright TitnaNano.de 2015
 * @memberof GrapeTweet
 */

$_('grapeTweet').module('Storage', [], function(App, ready){
	var dbRequest= $$.indexedDB.open('grapeTweetDB', 1);
	var AsyncLoop= $('classes').AsyncLoop;

	/**
	 * @type {IndexedDB}
	 * @memberof GrapeTweet.module:Storage
	 * @inner
	 */
	var db= null;

	/**
	 * @type {object}
	 * @property {object} conversations
	 * @property {object} contacts
	 * @memberof GrapeTweet.module:Storage
	 * @inner
	 */
    var caches= {
        conversations : {},
        contacts : {}
    };

	/**
	 * @type {object}
	 * @property {object} messages
	 * @property {GrapeTweet.module:Storage~listeners/add} add
	 * @property {GrapeTweet.module:Storage~listeners/collect} collect
	 * @memberof GrapeTweet.module:Storage
	 * @inner
	 */
    var listeners = {
        messages : {

        },

		/**
		 * Adds an event listner
		 * @function listeners/add
		 * @param {string} id
		 * @param {string} type
		 * @param {function} callback
		 * @memberof GrapeTweet.module:Storage
		 * @inner
		 */
        add : function(id, type, callback){
            var l= this[type][id]= this[type][id] || [];
            l.push(callback);
        },

		/**
		 * Collects all event listeners for the given event type.
		 *
		 * @function listeners/collect
		 * @param {string} type
		 * @param {string} id
		 * @returns {function[]}
		 * @memberof GrapeTweet.module:Storage
		 * @inner
		 */
        collect : function(type, id){
            var l= this[type][id];
            this[type][id]= [];
            return l || [];
        }
    };

    var StorePrototype= {
        methods : {
            save : function(){
                return Interface.saveStore(this);
            }
        },

        get : function(store, property){
            if(property in this.methods){
                return this.methods[property].bind(store);
            }else{
                return store[property];
            }
        },

        set : function(store, property, value){
            if(!this.methods[property]){
                store[property]= value;
            }
        }
    };

    var contactsCached= false;

    var getChunk= function(store, id, includeLast){
        return new $$.Promise(function(success){
            var list= [];
            var nextItem= id;

            (new AsyncLoop(function(next, exit){
                var request= db.transaction([store]).objectStore(store).get(nextItem);

                request.onsuccess= function(e){
                    var item= e.target.result;
                    if(item.last.split('@').length > 2){
                        var x= item.last.split('@');
                        x.pop();
                        item.last= x.join('@');
                    }
                    nextItem= item.last;

                    if(includeLast || item.id_str != id)
                        list.push(item);

                    if(nextItem !== null &amp;&amp; list.length &lt;= 20)
                        next();
                    else
                        exit();
                };

                request.onerror= exit;
            })).incalculable().then(function(){
                success(list);
            });
        });
    };

	dbRequest.onerror= function(){
		$$.console.error('unable to access the DB!');
	};

	dbRequest.onsuccess= function(){
		db= dbRequest.result;
		ready(Interface);
	};

	dbRequest.onupgradeneeded= function(e){
		var db= e.target.result;

		if(e.oldVersion &lt; 1){
			var direct_messages= db.createObjectStore('direct_messages', { keyPath : 'id_str' });
            var tweets= db.createObjectStore('tweets', { keyPath : 'id_str' });
			db.createObjectStore('contacts', { keyPath : 'id' });
			db.createObjectStore('stores', { keyPath : 'name' });
            db.createObjectStore('timelines', { keyPath : 'id' });

			direct_messages.createIndex('recipient_id', 'recipient_id', { unique : false });
			direct_messages.createIndex('sender_id', 'sender_id', { unique : false });
			tweets.createIndex('timeline', 'timeline', { unique : false });
		}
	};

	var Interface= {

//      classes
        Store : function(core){
            return new Proxy(core, StorePrototype);
        },

//		application states
		getStore : function(name){
			return new Promise(function(success, error){
				var request= db.transaction(['stores']).objectStore('stores').get(name);
				request.onsuccess= function(e){
					success(e.target.result || {});
				};

				request.onerror= error;
			});
		},

        getStores : function(){
            return new Promise(function(success, error){
                var list= [];
                var request= db.transaction(['stores']).objectStore('stores').openCursor();
                request.onsuccess= function(e){
                    if(e.target.result){
                        list.push(e.target.result.value);
                        e.target.result.continue();
                    }else{
                        success(list);
                    }
                };

                request.onerror= error;
            });
        },

		saveStore : function(store){
			return new Promise(function(success){
				var request= db.transaction(['stores'], 'readwrite').objectStore('stores').put(store);

				request.onsuccess= function(e){
					success(e.target.result);
				};

				request.onerror= function(){
					success(null);
				};
			});
		},

//		Direct Messages
		storeMessage : function(message){
			return new Promise(function(success, error){
				var request= db.transaction(['direct_messages'], 'readwrite').objectStore('direct_messages').put(message);

				request.onsuccess= function(e){
					success(e.target.result);
                    listeners.collect('messages', message.id_str).forEach(function(item){
                        if(item)
                            item(message);
                    });
				};

				request.onerror= error;
			});
		},

		getMessage : function(id, required){
			return new Promise(function(success, error){
				var request= db.transaction(['direct_messages']).objectStore('direct_messages').get(id);

				request.onsuccess= function(e){
					success(e.target.result);
				};

				request.onerror= function(e){
                    $$.console.log(e);
                    if(required){
                        listeners.add(id, 'messages', success);
                    }else{
                        error(e);
                    }
                };
			});
		},

		getMessagesChunkBefore : function(id, includeLast){
            return getChunk('direct_messages', id, includeLast);
		},

		getNewMessagesSince : function(id){
			return new Promise(function(success, error){
				var list= [];
				var nextMessage= null;

				var request= db.transaction(['direct_messages']).objectStore('direct_messages').get(id);

				request.onsuccess= function(e){
					nextMessage= e.target.result.next;

					if(nextMessage !== null){
						(new AsyncLoop(function(next, exit){
							var request= db.transaction(['direct_messages']).objectStore('direct_messages').get(nextMessage);

							request.onsuccess= function(e){
								var message= e.target.result;
								nextMessage= message.next;
								list.push(message);

								if(nextMessage !== null)
									next();
								else
									exit();
							};

							request.onerror= exit;
						})).incalculable().then(function(){
							success(list);
						});
					}else{
						success(list);
					}
				};

				request.onerror= error;
			});
		},

		checkDirectMessages : function(){
			return new Promise(function(done, error){
				var request= db.transaction(['direct_messages']).objectStore('direct_messages').openCursor();

				request.onsuccess= function(e){
					if(e.target.result)
						done(true);
					else
						done(false);
				};

				request.onerror= error;
			});
		},

//		contacts
		storeContact : function(contact){
			return new Promise(function(done, error){
                contact.id= String(contact.id);
                caches.contacts[contact.id]= contact;
				var request= db.transaction(['contacts'], 'readwrite').objectStore('contacts').put(contact);

				request.onsuccess= function(e){
					done(e.target.result);
				};

				request.onerror= function(e){
					error(e);
				};
			});
		},

		getContact : function(userId){
			return new Promise(function(success){
                userId= String(userId);

                if(!(userId in caches.contacts)){
				    var request= db.transaction(['contacts']).objectStore('contacts').get(userId);

				    request.onsuccess= function(e){
                        caches[userId]= e.target.result;
                        success(e.target.result);
				    };

				    request.onerror= function(){
                        success(null);
				    };
                }else{
                    success(caches.contacts[userId]);
                }
			});
		},

		getContacts : function(){
			return new Promise(function(done, error){
				if(!contactsCached){
                    var request= db.transaction(['contacts']).objectStore('contacts').openCursor();

				    request.onsuccess= function(e){
                        var cursor= e.target.result;

                        if(cursor){
                            if(!(cursor.key in caches.contacts))
                                caches.contacts[cursor.key]= cursor.value;
                            cursor.continue();
                        }else{
                            contactsCached= true;
                            done(caches.contacts);
                        }
                    };

                    request.onerror= function(e){
                        error(e);
				    };
                }else{
                    done(caches.contacts);
                }
			});
		},

//      tweets and timelines
        storeTweet : function(tweet, timeline){
            return new $$.Promise(function(done, error){
                tweet= JSON.parse(JSON.stringify(tweet));
                tweet.id_str+= '@'+timeline.id;
                tweet.last+= '@'+timeline.id;
                if(tweet.next !== null) tweet.next+= '@'+timeline.id;
                var request= db.transaction(['tweets'], 'readwrite').objectStore('tweets').put(tweet);

                request.onsuccess= function(e){
                    done(e.target.result);
                };

                request.onerror= function(e){
                    error(e);
                };
            });
        },

        getTweet : function(id, timeline){
            return new $$.Promise(function(done, error){
                var request= db.transaction(['tweets']).objectStore('tweets').get(id+'@'+timeline);

                request.onsuccess= function(e){
                    var tweet= e.target.result;
                    tweet.id_str= tweet.id_str.split('@')[0];
                    tweet.last= tweet.last.split('@')[0];
                    tweet.next= (tweet.next !== null) ? tweet.next.split('@')[0] : tweet.next;
                    done(tweet);
                };

                request.onerror= function(e){
                    error(e);
                };
            });
        },

        getTweetsChunkBefore : function(id, timeline, includeLast){
            return getChunk('tweets', id+'@'+timeline.id, includeLast).then(function(chunck){
                chunck.forEach(function(item){
                    item.id_str= item.id_str.split('@')[0];
                });
                return chunck;
            });
		},
	};
});
</pre>
	</article>
</section>





		</div>
	</div>

	<div class="clearfix"></div>

	

</div>
</div>


<footer>


	<span class="copyright">
	DocStrap Copyright © 2012-2014 The contributors to the JSDoc3 and DocStrap projects.
	</span>
	<br />

<span class="jsdoc-message">
	Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0-dev</a>
	on Sat Oct 31st 2015 using the <a
	href="https://github.com/terryweiss/docstrap">DocStrap template</a>.
</span>
</footer>

<!--<script src="scripts/sunlight.js"></script>-->
<script src="scripts/docstrap.lib.js"></script>
<script src="scripts/bootstrap-dropdown.js"></script>
<script src="scripts/toc.js"></script>

<script>
$( function () {
	$( "[id*='$']" ).each( function () {
		var $this = $( this );

		$this.attr( "id", $this.attr( "id" ).replace( "$", "__" ) );
	} );

	$( "#toc" ).toc( {
		anchorName  : function ( i, heading, prefix ) {
			var id = $( heading ).attr( "id" );
			return id && id.replace(/\~/g, '-inner-').replace(/\./g, '-static-') || ( prefix + i );
		},
		selectors   : "h1,h2,h3,h4",
		showAndHide : false,
		scrollTo    : "100px"
	} );

	$( "#toc>ul" ).addClass( "nav nav-pills nav-stacked" );
	$( "#main span[id^='toc']" ).addClass( "toc-shim" );
	$( '.dropdown-toggle' ).dropdown();
	//			$( ".tutorial-section pre, .readme-section pre" ).addClass( "sunlight-highlight-javascript" ).addClass( "linenums" );

	$( ".tutorial-section pre, .readme-section pre" ).each( function () {
		var $this = $( this );

		var example = $this.find( "code" );
		exampleText = example.html();
		var lang = /{@lang (.*?)}/.exec( exampleText );
		if ( lang && lang[1] ) {
			exampleText = exampleText.replace( lang[0], "" );
			example.html( exampleText );
			lang = lang[1];
		} else {
			lang = "javascript";
		}

		if ( lang ) {

			$this
			.addClass( "sunlight-highlight-" + lang )
			.addClass( "linenums" )
			.html( example.html() );

		}
	} );

	Sunlight.highlightAll( {
		lineNumbers : true,
		showMenu : true,
		enableDoclinks : true
	} );
} );
</script>



<!--Navigation and Symbol Display-->


<!--Google Analytics-->


</body>
</html>
