<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<title>GrapeTweet Source: src/js/ui.js</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.default.css">

	<link type="text/css" rel="stylesheet" href="styles/site.paper.css">

</head>

<body>

<div class="navbar navbar-default navbar-fixed-top navbar-inverse">
<div class="container">
	<div class="navbar-header">
		<a class="navbar-brand" href="index.html">GrapeTweet</a>
	</div>
	<div class="navbar-collapse">
		<ul class="nav navbar-nav">
			
			<li class="dropdown">
				<a href="namespaces.list.html" class="dropdown-toggle" data-toggle="dropdown">Namespaces<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="external-af.connections.html">external:af.connections</a></li><li><a href="GrapeTweet.html">GrapeTweet</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="modules.list.html" class="dropdown-toggle" data-toggle="dropdown">Modules<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="GrapeTweet.module_Audio.html">GrapeTweet.Audio</a></li><li><a href="GrapeTweet.module_Bindings.html">GrapeTweet.Bindings</a></li><li><a href="GrapeTweet.module_Cache.html">GrapeTweet.Cache</a></li><li><a href="GrapeTweet.module_Gestures.html">GrapeTweet.Gestures</a></li><li><a href="GrapeTweet.module_Initializer.html">GrapeTweet.Initializer</a></li><li><a href="GrapeTweet.module_Misc.html">GrapeTweet.Misc</a></li><li><a href="GrapeTweet.module_Net.html">GrapeTweet.Net</a></li><li><a href="GrapeTweet.module_Storage.html">GrapeTweet.Storage</a></li><li><a href="GrapeTweet.module_UI.html">GrapeTweet.UI</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="classes.list.html" class="dropdown-toggle" data-toggle="dropdown">Classes<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="Conversation.html">Conversation</a></li><li><a href="GrapeTweet.module_Initializer-Catalog.html">GrapeTweet.Initializer~Catalog</a></li><li><a href="GrapeTweet.module_Initializer-TailTip.html">GrapeTweet.Initializer~TailTip</a></li><li><a href="Promise.html">Promise</a></li><li><a href="Timeline.html">Timeline</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="global.html" class="dropdown-toggle" data-toggle="dropdown">Global<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="global.html">Global</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="externals.list.html" class="dropdown-toggle" data-toggle="dropdown">Externals<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="external-af.html">af</a></li>
				</ul>
			</li>
			
		</ul>
	</div>
</div>
</div>


<div class="container">
<div class="row">

	
	<div class="col-md-12">
	
		<div id="main">
    		<h1 class="page-title">Source: src/js/ui.js</h1>
			

		<h1 class="page-title">Source: src/js/ui.js</h1>
    
<section>
	<article>
		<pre
			class="sunlight-highlight-javascript linenums">/**
 * @module UI
 * @author Jovan Gerodetti
 * @copyright TitnaNano.de 2015
 * @memberof GrapeTweet
 */
$_('grapeTweet').module('UI', ['Storage', 'Misc', 'Net', 'Cache', 'Gestures'], function(App, done){

    var client= $('dom').select('.client.twitter');

    var { Storage, Misc, Cache, Gestures } = App.modules;

    /**
     * creates a DOM representation of a direct messae
     *
     * @param {object} item
     * @param {Contact} contact
     * @param {boolean} insertBefore
     * @param {boolean} avatarize
     * @return {Node}
     * @memberof GrapeTweet.module:UI
     * @inner
     */
    var renderMessage= function(item, contact, insertBefore, avatarize){
        var template_default= $('dom').select('#chat-message-layout').content;
        var template_my= $('dom').select('#chat-my-message-layout').content;
        var list= $('dom').select('.message-list');
        var firstElement= $('dom').select('.page.chat .message-list li');
        var element= null;
        var out = item.sender_id == App.Account.userId;
        contact= contact || (item.sender_id != App.Account.userID ? item.sender : item.recipient);

        if(!list.querySelector('li[data-id="'+ item.id_str +'"]')){
            if(out){
                element= template_my.cloneNode(true);
                element.querySelector('.message').dataset.id= item.id_str;
            }else{
                element= template_default.cloneNode(true);
                if(avatarize)
                    element.querySelector('.user-image').style.setProperty('background-image', 'url('+ contact.profile_image_url +')');
                element.querySelector('.message').dataset.id= item.id_str;
            }

//	 	    format text
            renderEntities(item.text, item.entities, element.querySelector('.text'));
            Storage.storeMessage(item);

//		    timestamp
            var date= new Date(item.created_at);
            element.querySelector('.date').textContent= date.toLocaleDateString() + ', ' + date.toLocaleTimeString();

            if(!insertBefore)
                list.appendChild(element);
            else
                list.insertBefore(element, firstElement);

            return out;
        }
    };

    /**
     * Adds all entities of a tweet or direct message to it's DOM representation
     *
     * @param {string} text
     * @param {Array} entities
     * @param {Node} target
     * @param {Tweet} tweet
     * @memberof GrapeTweet.module:UI
     * @inner
     */
    var renderEntities= function(text, entities, target, tweet){

        var textElement= $('dom').create('div');
        textElement.innerHTML= text;
        target.appendChild(textElement);

//      add medias
        if (entities.media) {
            var addImageListeners= function(item, img, blob, url){
                if($$.MozActivity){
                    img.addEventListener('click', function(){
                        new $$.MozActivity({
                            name : 'open',
                            data : {
                                type : blob.type,
                                blob : blob
                            }
                        });
                    });
                }
                if(tweet){
                    img.addEventListener('contextmenu', function(e){
                        e.preventDefault();
                        var link= $('dom').create('a');
                        link.href= url;
                        link.download= item.media_url.substr(item.media_url.lastIndexOf('/'));
                        $$.document.body.appendChild(link);
                        link.click();
                        $$.document.body.removeChild(link);
                    });
                }
            };

            entities.media.forEach(function(item){
                if(item.type == 'photo'){
                    textElement.innerHTML= textElement.innerHTML.replace(item.url, '');
                    var img= $('dom').create('img');

//                    img.style.height= target.style.minHeight= item.sizes.large.h / item.sizes.large.w * ($$.innerWidth - 34 - ($$.innerWidth / 100 * 25))+'px';

                    item.media_url += ':small';

                    $$.console.log('fetching image: ', item.media_url);

                    if(!tweet){
                        img.src= "../img/image-thumb.png";
//                        img.addEventListener('click', downloadImage.bind(img, [item]));
                    } else {
                        Cache.fetchPicture(item.media_url).then(function(data){
                            img.src = data.url;

                            addImageListeners(item, img, data.blob, data.url);
                        });
                    }

                    target.appendChild(img);
                }
            });
        }

        if(entities.urls){
            entities.urls.forEach(function(item){
                textElement.innerHTML= textElement.innerHTML.replace(item.url, '&lt;a href="'+ item.url +'" target="_blank">'+ item.display_url +'&lt;/a>');

                if (item.display_url.search('^youtu.be') > -1) {
                    var anker = $('dom').create('a');

                    anker.className = 'video-wrapper';
                    anker.href = item.url;
                    anker.target = '_external';

                    anker.appendChild($('dom').create('img'));
                    anker.lastChild.src = 'http://img.youtube.com/vi/' + item.display_url.split('/')[1].split('?')[0] +'/default.jpg';

                    anker.appendChild($('dom').create('i'));
                    anker.lastChild.className = 'material-icons';
                    anker.lastChild.innerHTML = '&amp;#xE039;';

                    target.appendChild(anker);
                } else if (item.display_url.search('^instagram.com') > -1) {
                    var img = $('dom').create('img');

                    img.src = 'https://' + item.display_url + 'media/?size=t';

                    target.appendChild(img);
                }
            });
        }
    };

    /**
     * Generates a string representating the time difference between now and the given timestamp
     *
     * @param {string} timeString
     * @returns {string}
     * @memberof GrapeTweet.module:UI
     * @inner
     */
    var getTimeSince= function(timeSting){
        var now= new Date();
        var from= new Date(timeSting);
        var time= new Date(now - from);

        if(time.getYear() - 70 > 0)
            return (time.getYear() - 70) + 'Y';
        else if(time.getMonth() > 0)
            return time.getMonth() + 'M';
        else if(time.getDate() - 1 > 0)
            return (time.getDate() - 1) + 'd';
		else if(time.getHours() - 1 > 0)
            return (time.getHours() - 1) + 'h';
        else if(time.getMinutes() > 0)
            return time.getMinutes() + 'm';
        else if(time.getSeconds() > 0)
            return time.getSeconds() + 's';
        else
            return 'now';
	};

	var Interface= {
        /**
         * switches to a given sheet
         *
         * @param {string} selector
         * @return {null}
         * @memberof GrapeTweet.module:UI
         */
        switchSheet : function(selector){
            var activeSheet= $('dom').select('.sheet.active');
            var newSheet= $('dom').select(selector);

            if(activeSheet &amp;&amp; activeSheet != newSheet){
                activeSheet.querySelector('.body').style.setProperty('will-change', 'opacity');
                newSheet.querySelector('.body').style.setProperty('will-change', 'opacity');
                client.transition('change').then(function(){
                    newSheet.classList.add('active');
                    activeSheet.classList.remove('active');
                    $$.setTimeout(function(){
                        client.classList.remove('change');
                    }, 30);
                });
            }else{
                newSheet.classList.add('active');
            }
        },

        /**
         * moves two pages from right to left
         *
         * @param {string} sheet
         * @param {string} from
         * @param {string} to
         * @returns {Promise}
         * @memberof GrapeTweet.module:UI
         */
        pagesToLeft : function(sheet, from, to){
            return new $$.Promise(function(done){
                $('dom').select('.sheet.'+ sheet +' .page.'+ from).classList.add('left');
                $('dom').select('.sheet.' + sheet +' .page.'+ to).transition(null, 'right').then(done);
            });
        },

        /**
         * moves two pages from left to right
         *
         * @param {string} sheet
         * @param {string} from
         * @param {string} to
         * @returns {Promise}
         * @memberof GrapeTweet.module:UI
         */
        pagesFromLeft : function(sheet, from, to) {
            return new $$.Promise(function(done){
                $('dom').select('.sheet.' + sheet +' .page.'+ from).classList.add('right');
                $('dom').select('.sheet.'+ sheet +' .page.'+ to).transition(null, 'left').then(done);
            });
        },

        /**
         * creates the DOM representation for the contact list
         *
         * @memberof GrapeTweet.module:UI
         */
        renderContacts : function(){
            var contacts= App.Contacts.record;
            var template= $('dom').select('#contact-layout').content;
            var list= $('dom').select('.contact-list');

            list.innerHTML= '';

            $$.Object.keys(contacts).forEach(function(item){
                item= contacts[item];
                var element= template.cloneNode(true);

                element.querySelector('.contact').dataset.userId= item.id;
                element.querySelector('.user-image').style.setProperty('background-image', 'url("'+ item.profile_image_url +'")');
                element.querySelector('.displayname').textContent= item.name;
                element.querySelector('.username').textContent= '@' + item.screen_name;

                list.appendChild(element);
            });
        },

        /**
         * creates the DOM representation for the chats list
         *
         * @memberof GrapeTweet.module:UI
         *
         *//**
         * creates the DOM representation for a single chat in the chats list
         *
         * @param chatId
         * @memberof GrapeTweet.module:UI
         */
        renderChats : function(chatId){
            var conversations = App.Conversations.record;
            var tempList= {};
            var contacts = App.Contacts.record;
            var template= $('dom').select('#conv-layout').content;
            var list= $('dom').select('.conv-list');

            if(!chatId){

//              sort conversations
                $$.Object.keys(conversations).map(function(id){
                    return { id:id, created_at : conversations[id].lastMessage.created_at };
                })

                .sort(Misc.sortByDate).reverse().map(function(item){
                    tempList[item.id]= conversations[item.id];
                });

                conversations= tempList;

            }else{
                conversations= {
                    chatId : conversations[chatId]
                };
            }

            $$.Object.keys(conversations).forEach(function(userId){
                var conv= conversations[userId];
                var latest= conv.lastMessage;
                var user= contacts[userId]  || (latest.sender_id_str != App.Account.userId ? latest.sender : latest.recipient);
                var old= null;
                var element= template.cloneNode(true);

                element.querySelector('.conv').dataset.userId= userId;

                if(conv.unread > 0)
                    element.querySelector('.conv').classList.add('unread');
                else if(latest.sender_id == App.Account.userId)
                    element.querySelector('.conv').classList.add('my');

                element.querySelector('.user-image').style.setProperty('background-image', 'url('+ Misc.getAvatar('bigger', user.profile_image_url) +')');
                element.querySelector('.displayname').textContent= user.name;

                if( (user.name + '@' + user.screen_name).length > 23)
                    element.querySelector('.username').textContent= '@' + user.screen_name;
                else
                    element.querySelector('.username').textContent= '@' + user.screen_name;

                element.querySelector('.datetime').textContent= getTimeSince(latest.created_at);
                element.querySelector('.conv-body .text').textContent= ((latest.text.length &lt;= 40) ? latest.text : latest.text.substr(0, 40) + '...');

                if((old= list.querySelector('[data-user-id="'+ userId +'"]')) !== null){
                    list.replaceChild(element, old);
                }else{
                    list.appendChild(element);
                }
            });
        },

        /**
         * creates the DOM representation for a chat
         *
         * @param {string} userId
         * @memberof GrapeTweet.module:UI
         */
        renderChat : function(userId){
            var conversation= App.Conversations.record[userId];
            var contact= App.Contacts.record[userId] ? App.Contacts.record[userId] : (conversation.lastMessage.sender || conversation.lastMessage.recipient);
            var list= $('dom').select('.message-list');
            var differentConv= (list.dataset.userId != userId);
            var userImage= $('dom').select('.page.chat .header-user-image');
            var body= $('dom').select('.page.chat .body.c');

//			close notification for this conversation
            $$.Notification.get().then(function(list){
                list.forEach(function(item){
                    if(item.tag == userId)
                        item.close();
                });
            });

//			setup page
            if(differentConv){
                list.innerHTML= '';
                $('dom').select('.page.chat .back-title').textContent= contact.name;

                userImage.style.setProperty('background-image', 'url('+ Misc.getAvatar('bigger', contact.profile_image_url) +')');
                userImage.href= '#!/people/profile/'+ contact.id;
                list.dataset.userId= contact.id;
            }

            if(conversation){
                var handle= function(messages){
                    var avatarize = (list.childNodes.length > 0) ? list.lastElementChild.classList.contains('me') : true;

                    if(messages.length > 0){
                        messages.sort(Misc.sortByDate);
                        messages.forEach(function(item){
                            avatarize = renderMessage(item, contact, false, avatarize);
                        });

                        App.Account.unreadMessages-= conversation.unread;
                        conversation.lastReadMessage= messages.last().id_str;
                        conversation.unread= 0;
                        App.Conversations.save();

                        Interface.renderFooterStatus(App.Account);
                    }
                };

                if(differentConv){
                    Storage.getMessagesChunkBefore(conversation.lastMessage.id_str, true).then(handle).then(function(){
                        body.scrollTop= body.scrollHeight;
                    });
                }else{
                    var scroll= (body.scrollTop == (body.scrollHeight - body.offsetHeight));
                    Storage.getNewMessagesSince(conversation.lastReadMessage).then(handle).then(function(){
                        if(scroll) body.scrollTop= body.scrollHeight;
                    });
                }
            }
        },

        /**
         * creates the DOM representation for the previous chunk of messages
         *
         * @function
         * @returns {Promise}
         * @memberof GrapeTweet.module:UI
         */
        renderAdditionalChunk : function(){
            return new $$.Promise(function(done){
                var lastElement= $('dom').select('.page.chat .message-list li');
                var body= $('dom').select('.page.chat .body');
                var scrollHeight= body.scrollHeight;

                if(lastElement){
                    $$.Promise.all([
                        Storage.getMessagesChunkBefore(lastElement.dataset.id, false),
                        Storage.getContact(App.DataStatus.DMs.lastChat)
                    ]).then(function(values){
                        var messages= values[0].sort(Misc.sortByDate);
                        var contact= values[1];
                        var avatarize = $('dom').select('.page.chat .message-list').lastElementChild.classList.contains('me');

                        messages.reverse().forEach(function(item){
                            avatarize = renderMessage(item, contact, true, avatarize);
                        });

                        body.scrollTop= body.scrollHeight - scrollHeight - 20;
                        done();
                    });
                }else{
                    done();
                }
            });
        },

        /**
         * updates the status of the footer
         *
         * @param {Account}
         * @memberof GrapeTweet.module:UI
         */
        renderFooterStatus : function(account){
            var label= $('dom').select('.footer .messages .count');
            if(account.unreadMessages > 0){
                label.textContent= account.unreadMessages;
                label.classList.remove('hidden');
            }else{
                label.classList.add('hidden');
            }
        },

        /**
         * creates the DOM representation for tweets of the given timeline
         *
         * @param {Timeline}
         * @returns {Proimse}
         * @memberof GrapeTweet.module:UI
         */
        renderTweets : function(timeline){
            return Storage.getTweetsChunkBefore(timeline.last, timeline, true).then(function(tweets){
                var template= $('dom').select('#tweet-layout').content;
                var list= $('dom').select('.streams .page[data-id="'+ timeline.id +'"] .tweet-list');

                list.innerHTML= '';
                tweets.forEach(function(tweet){
                    var element= template.cloneNode(true);

                    element.querySelector('.tweet').dataset.id= tweet.id_str;
                    element.querySelector('.displayname').textContent= tweet.user.name;
                    element.querySelector('.username').textContent= '@' + tweet.user.screen_name;
                    element.querySelector('.user-image').style.setProperty('background-image', 'url('+ Misc.getAvatar('bigger', tweet.user.profile_image_url) +')');
                    element.querySelector('.datetime').textContent= getTimeSince(tweet.created_at);
                    renderEntities(tweet.text, tweet.entities, element.querySelector('.text'), true);
//                    Storage.storeTweet(tweet, timeline);

                    list.appendChild(element);
                });
            });
        },

        /**
         * creates the DOM representation for the given timeline
         *
         * @param {Timeline}
         * @memberof GrapeTweet.module:UI
         */
        renderTimeline : function(timeline){
            var template= $('dom').select('#timeline-layout').content;
            var element= template.cloneNode(true);

            element.querySelector('.title').textContent= timeline.name;
            element.querySelector('.page').dataset.id= timeline.id;
            element.querySelector('.body').addEventListener('scroll', function(e){
                e.preventDefault();
            });

            Gestures.PullDownToRefresh(element.querySelector('.body'), timeline, Interface);

            element.querySelector('.header').addEventListener('click', function(){
                if(!this.active){
                    this.active= true;
                    var int= $$.setInterval(function(){
                        if(this.element.scrollTop > 0){
                            this.element.scrollTop-= 40;
                        }else{
                            $$.clearInterval(int);
                            this.active= false;
                        }
                    }.bind(this), 0);
                }
            }.bind({
                element : element.querySelector('.body'),
                active : false
            }));

            $('dom').select('.streams').appendChild(element);
        },

        /**
         * travels up the dome tree relative to the given element, searching for an element matching the given selector
         *
         * @param {Node} element
         * @param {string} selector
         * @returns {Node}
         * @memberof GrapeTweet.module:UI
         */
        findElement : function(element, selector){
            var target= null;
            while(!target){
                target= element.querySelector(selector);
                element= element.parentNode;
                if(!element) break;
            }
            return target;
        }
    };

    done(Interface);
});
</pre>
	</article>
</section>





		</div>
	</div>

	<div class="clearfix"></div>

	

</div>
</div>


<footer>


	<span class="copyright">
	DocStrap Copyright © 2012-2014 The contributors to the JSDoc3 and DocStrap projects.
	</span>
	<br />

<span class="jsdoc-message">
	Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0-dev</a>
	on Sat Oct 31st 2015 using the <a
	href="https://github.com/terryweiss/docstrap">DocStrap template</a>.
</span>
</footer>

<!--<script src="scripts/sunlight.js"></script>-->
<script src="scripts/docstrap.lib.js"></script>
<script src="scripts/bootstrap-dropdown.js"></script>
<script src="scripts/toc.js"></script>

<script>
$( function () {
	$( "[id*='$']" ).each( function () {
		var $this = $( this );

		$this.attr( "id", $this.attr( "id" ).replace( "$", "__" ) );
	} );

	$( "#toc" ).toc( {
		anchorName  : function ( i, heading, prefix ) {
			return $( heading ).attr( "id" ) || ( prefix + i );
		},
		selectors   : "h1,h2,h3,h4",
		showAndHide : false,
		scrollTo    : "100px"
	} );

	$( "#toc>ul" ).addClass( "nav nav-pills nav-stacked" );
	$( "#main span[id^='toc']" ).addClass( "toc-shim" );
	$( '.dropdown-toggle' ).dropdown();
	//			$( ".tutorial-section pre, .readme-section pre" ).addClass( "sunlight-highlight-javascript" ).addClass( "linenums" );

	$( ".tutorial-section pre, .readme-section pre" ).each( function () {
		var $this = $( this );

		var example = $this.find( "code" );
		exampleText = example.html();
		var lang = /{@lang (.*?)}/.exec( exampleText );
		if ( lang && lang[1] ) {
			exampleText = exampleText.replace( lang[0], "" );
			example.html( exampleText );
			lang = lang[1];
		} else {
			lang = "javascript";
		}

		if ( lang ) {

			$this
			.addClass( "sunlight-highlight-" + lang )
			.addClass( "linenums" )
			.html( example.html() );

		}
	} );

	Sunlight.highlightAll( {
		lineNumbers : true,
		showMenu : true,
		enableDoclinks : true
	} );
} );
</script>



<!--Navigation and Symbol Display-->


<!--Google Analytics-->


</body>
</html>
