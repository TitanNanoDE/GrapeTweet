<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<title>GrapeTweet Source: src/js/app.js</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.default.css">

	<link type="text/css" rel="stylesheet" href="styles/site.paper.css">

</head>

<body>

<div class="navbar navbar-default navbar-fixed-top navbar-inverse">
<div class="container">
	<div class="navbar-header">
		<a class="navbar-brand" href="index.html">GrapeTweet</a>
	</div>
	<div class="navbar-collapse">
		<ul class="nav navbar-nav">
			
			<li class="dropdown">
				<a href="namespaces.list.html" class="dropdown-toggle" data-toggle="dropdown">Namespaces<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="external-af.connections.html">external:af.connections</a></li><li><a href="GrapeTweet.html">GrapeTweet</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="modules.list.html" class="dropdown-toggle" data-toggle="dropdown">Modules<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="GrapeTweet.module_Audio.html">GrapeTweet.Audio</a></li><li><a href="GrapeTweet.module_Bindings.html">GrapeTweet.Bindings</a></li><li><a href="GrapeTweet.module_Cache.html">GrapeTweet.Cache</a></li><li><a href="GrapeTweet.module_Gestures.html">GrapeTweet.Gestures</a></li><li><a href="GrapeTweet.module_Initializer.html">GrapeTweet.Initializer</a></li><li><a href="GrapeTweet.module_Misc.html">GrapeTweet.Misc</a></li><li><a href="GrapeTweet.module_Net.html">GrapeTweet.Net</a></li><li><a href="GrapeTweet.module_Storage.html">GrapeTweet.Storage</a></li><li><a href="GrapeTweet.module_UI.html">GrapeTweet.UI</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="classes.list.html" class="dropdown-toggle" data-toggle="dropdown">Classes<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="Conversation.html">Conversation</a></li><li><a href="GrapeTweet.module_Initializer-Catalog.html">GrapeTweet.Initializer~Catalog</a></li><li><a href="GrapeTweet.module_Initializer-TailTip.html">GrapeTweet.Initializer~TailTip</a></li><li><a href="Promise.html">Promise</a></li><li><a href="Timeline.html">Timeline</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="global.html" class="dropdown-toggle" data-toggle="dropdown">Global<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="global.html">Global</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="externals.list.html" class="dropdown-toggle" data-toggle="dropdown">Externals<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="external-af.html">af</a></li>
				</ul>
			</li>
			
		</ul>
	</div>
</div>
</div>


<div class="container">
<div class="row">

	
	<div class="col-md-12">
	
		<div id="main">
    		<h1 class="page-title">Source: src/js/app.js</h1>
			

		<h1 class="page-title">Source: src/js/app.js</h1>
    
<section>
	<article>
		<pre
			class="sunlight-highlight-javascript linenums">/**
 *
 * @namespace GrapeTweet
 * @author Jovan Gerodetti
 */

$_('grapeTweet').main(function(){
    var OAuthClient= $('connections').classes.OAuthClient;
    var Socket= $('connections').classes.Socket;

    var { Net, Misc, Storage, UI, Audio, Bindings, Initializer } = App.modules;

    var App= this;

    /**
     * @memberof GrapeTweet
     * @name twitterSocket
     * @type {external:af.connections.OAuthClient}
     */
    this.twitterSocket= new OAuthClient('twitter', 'https://api.twitter.com', 'TLeiAYSBAbIKnSWZ9qIg72PLI', 'HTSLlTLxiC1fbLzkxa4D2YaYRxRA58Eor8zGFMQEpRPYou4g2V', { mozSystem : true });

    /**
     * @memberof GrapeTweet
     * @name pushServer
     * @type {external:af.connections.Socket}
     */
    this.pushServerSocket= new Socket(Socket.HTTP, 'https://grapetweet-titannano.rhcloud.com',  { mozSystem : true });

    $$.App= this;

    /**
     * @type {object}
     * @property {object} Account
     * @property {string} Account.name
     * @property {number} Account.unreadMessages
     * @property {number} Account.userId
     * @memberof GrapeTweet
     * @inner
     */
    var Defaults = {
        Account : {
            name : 'Account',

            unreadMessages : 0,
            userId : 0
        },

        Conversations : {
            name : 'Conversations',
            record : {}
        },

        Contacts : {
            name : 'Contacts',
            record : {}
        },

        Timelines : {
            name : 'Timelines',
            record : {}
        },

        PushServer : {
            name : 'PushServer',

            ready : false,
            id : 0,
            endpoint : '',
            lastRefresh : 0
        },

        DataStatus : {
            name : 'DataStatus',

            DMs : {
                lastIn : '',
                lastOut : '',
                lastPull : 0,
                lastChat : ''
            },

            contacts : {
                fetchingInfo : false,
                nextFollowingCursor : '-1',
                nextFollowerCursor : '-1',
                nextContact : '',
                lastSync : '',
                followerCache : [],
                followingCache : [],
                contactsCache : []
            }
        }
    };

    /**
     * @name loadingChunk
     * @memberof GrapeTweet
     * @type {boolean}
     */
    this.loadingChunk= false;

    /**
     * @memberof GrapeTweet
     * @name cache
     * @type {object}
     * @property {object} images
     */
    this.cache = {
        images : {}
    };

    /**
     * @memberof GrapeTweet
     * @function objectReplace
     * @see GrapeTweet.module:Misc.objectApply
     */
    this.objectReplace = Misc.objectApply;

    var notificationClick= function(e){
        App.openChat(e.target.tag);
        App.show();
    };

    var requestEndpoint= function(callback){
        $$.navigator.push.registrations().onsuccess= function(){
            if(this.result instanceof Array){
                this.result.forEach(function(item){
                    $$.navigator.push.unregister(item.pushEndpoint);
                });
            }
        };

        $$.console.log('requesting push-endpoint...');
        var endpointRequest= $$.navigator.push.register();

        endpointRequest.onsuccess= function(){
            callback(endpointRequest.result);
        };

        endpointRequest.onerror= function(e){
            $$.console.error('D: we couldn\'t get a new endpoint!! ' + $$.JSON.stringify(e) + ' Retry in 10 seconds!');
            $$.setTimeout(function(){ requestEndpoint(callback); }, 10000);
        };
    };

    var registerPushClient= function(){
        $$.console.log('registering at the push-server...');
        requestEndpoint(function(endpoint){
            App.pushServerSocket.request('/register', $$.JSON.stringify({ endpoint : endpoint })).then(function(data){
                data= $$.JSON.parse(data);
                App.pushServerSocket.request('/verify', $$.JSON.stringify({
                    id : data.clientId,
                    x1 : App.twitterSocket.exposeToken()[0],
                    x2 : App.twitterSocket.exposeToken()[1]
                })).then(function(){
                    App.objectReplace(App.PushServer, {
                        id : data.clientId,
                        ready : true,
                        endpoint : endpoint,
                        lastRefresh : Date.now()
                    });

                    App.PushServer.save();

                    $$.console.log('push-server successfully registered!');
                });
            });
        });
    };

    var fixKeyboard = function(){
        $$.addEventListener('mousedown', Bindings.keepKeyboardOpen);
    };

    /**
     * keeps the keyboard open for a given DOM element
     *
     * @function fixKeyboard
     * @param {Node} element
     * @memberof GrapeTweet
     */
    this.fixKeyboard = function(element) {
        element.addEventListener('focus', fixKeyboard);
        element.focus();
    };

    /**
     * releases the keyborad lock for a given element
     *
     * @function releaseKeyboard
     * @param {Node} element
     * @memberof GrapeTweet
     */
    this.releaseKeyboard = function(element) {
        element.removeEventListener('focus', fixKeyboard);
        element.blur();
    };

    /**
     * updates the push server registration
     *
     * @function updatePushServer
     * @param {boolean} force
     * @memberof GrapeTweet
     */
    this.updatePushServer= function(force){
        if(!App.PushServer.ready){
            registerPushClient();
        }else if( (Date.now() - App.PushServer.lastRefresh) > 7200000 || force){
            requestEndpoint(function(endpoint){
                App.pushServerSocket.request('/updateEndpoint', $$.JSON.stringify({ id : App.PushServer.id, endpoint : endpoint })).then(function(data){
                    data= $$.JSON.parse(data);

                    if(data.status > 0){
                        App.objectReplace(App.PushServer, {
                            endpoint : endpoint,
                            lastRefresh : Date.now()
                        });

                        App.PushServer.save();

                        $$.console.log('push-endpoint successfully updated!');
                    }else{
                        $$.console.log('server doesn\'t know us :/');
                        App.PushServer.ready= false;

                        App.PushServer.save();

                        App.updatePushServer();
                    }
                });
            });
        }else{
            $$.console.log('push server already registered!');
        }
    };

    /**
     * Pulls all new messages from the push server
     *
     * @function pullPushMessages
     * @memberof GrapeTweet
     */
    this.pullPushMessages= function(){
        Net.pullPushMessages().then(function(values){
            var data= $$.JSON.parse(values[0]);
            var conversations= values[1];

            if(data.status > 0){
                data.messages.forEach(function(item){
                    if(item.type == 'direct_message'){
                        var convId= (item.sender_id == App.Account.userId) ? item.recipient_id : item.sender_id;

                        App.integrateIntoMessagesChain(item, conversations[convId]).then(function(){
                            App.notify(convId);

                            var chatPage= $('dom').select('.message-list');
                            if(!$$.document.hidden &amp;&amp; $$.location.hash.indexOf('/chat') > -1)
                                UI.renderChat(chatPage.dataset.userId);
                        });
                    }else if(item.type == 'server_crash'){
                        Socket.request('/reverify', $$.JSON.stringify({
                            id : App.PushServer.id,
                            x1 : App.twitterSocket.exposeToken()[0],
                            x2 : App.twitterSocket.exposeToken()[1]
                        })).then();
                    }
                });
            }else{
                $$.console.error(data);
            }
        },function(e){
            $$.console.error('Network error!');
            $$.console.error(e);
        });
    };

    /**
     * opens the chat page
     *
     * @function openChat
     * @param {string} e
     * @memberof GrapeTweet
     *
     *//**
     * opens the chat page
     *
     * @function openChat
     * @param {Event} e
     * @memberof GrapeTweet
     */
	this.openChat= function(e){
        App.DataStatus.DMs.lastChat= ((e.target) ? e.target.dataset.userId : e);
        App.DataStatus.save();

        $$.location.hash= '#!/messages/chat';
	};

    /**
     * notifies the OS about the new messages in a given conversation
     *
     * @function notify
     * @param {string} conversationId
     * @memberof GrapeTweet
     */
	this.notify= function(conversationId){
        var conversation= App.conversations.record[conversationId];
        var message= conversation.lastMessage;

        UI.renderChats(conversationId);

        if(message.sender_id != App.Account.userId){
            $$.console.log('display Notification!!');
            UI.renderFooterStatus(App.Account);
            if($$.document.hidden || $$.location.hash.indexOf('/messages') &lt; 0 || ($$.location.hash.indexOf('/chat') > -1 &amp;&amp; App.DataStatus.lastChat != message.sender_id)){
                var textBody= (conversation.unread &lt; 2) ? Misc.cutdown(message.text) : conversation.unread + ' new messages';

                var notification= new $$.Notification(message.sender.name, {
                    body : textBody,
                    tag : message.sender_id,
                    icon : message.sender.profile_image_url
                });

                notification.addEventListener('click', notificationClick, false);
            }else{
                Audio.play('recieved');
                $$.navigator.vibrate([250,300,250]);
            }
        }else if(!$$.document.hidden){
            Audio.play('sent');
        }
	};

    /**
     * Brings the application to the forground
     *
     * @function show
     * @memberof GrapeTweet
     */
	this.show= function(){
		if($$.document.hidden){
			$$.navigator.mozApps.getSelf().onsuccess= function(e){
				e.target.result.launch();
    		};
  		}
	};

    /**
     * @class Conversation
     * @property {string} id
     * @property {DirectMessage} lastMessage
     * @property {?DirectMessage} lastReadMessage
     * @property {boolean} unread
     */

    /**
     * Creates a new {Conversation}
     *
     * @function createConversation
     * @param {string} id
     * @param {DirectMessage} lastmessage
     * @param {boolean} unread
     * @returns {Conversation}
     * @memberof GrapeTweet
     */
	this.createConversation= function(id, lastmessage, unread){
		return {
			id : String(id),
			lastMessage : lastmessage,
			lastReadMessage : null,
			unread : unread
		};
	};

    /**
     * Integrates a message into the message list of the given conversation
     *
     * @function integrateIntoMessagesChain
     * @param {DirectMessage} message
     * @param {Conversation} conversation
     * @memberof GrapeTweet
     */
	this.integrateIntoMessagesChain= function(message, conversation){
        var self= this;
		return new $$.Promise(function(done){
            if(!self.active){
                self.active= true;
                self.integrate.apply(self, [message, conversation, done]);
                self.next();
            }else{
                self.queue.push([message, conversation, done]);
            }
		});
	}.bind({
        queue : [],
        active : false,
        next : function(){
            if(this.queue.length > 0){
                this.integrate.apply(this, this.queue.shift());
                this.next();
            }else{
                this.active= false;
            }
        },
        integrate : function(message, conversation, callback){
            if(conversation &amp;&amp; conversation.lastMessage != message){
                message.last= conversation.lastMessage.id_str;
                message.next= null;

                conversation.lastMessage= message;
                if(message.sender_id != App.Account.userId){
                    conversation.unread= (conversation.unread > 0) ? conversation.unread+1 : 1;
                    App.Account.unreadMessages= (App.Account.unreadMessages > 0) ? App.Account.unreadMessages+1 : 1;
                    App.Account.save();
                }

                App.Conversations.record[conversation.id] = conversation;
                App.Conversations.save();

                Storage.storeMessage(message).then(function(){
                    Storage.getMessage(message.last).then(function(oldMessage){
                        oldMessage.next= message.id_str;
                        Storage.storeMessage(oldMessage).then(callback);
                    });
                });
            }else if(conversation){
                Storage.getMessage(message.id_str).then(function(oldMessage){
                    message.last= oldMessage.last;
                    message.next= oldMessage.next;
                    Storage.storeMessage(message).then(callback);
                });
            }else{
                var convId= (message.sender_id == App.Account.userId) ? message.recipient_id : message.sender_id;
                message.last= null;
                message.next= null;

                App.Conversations.record[convId] = App.createConversation(convId, message, (message.sender_id != App.Account.userId) ? 1 : 0);
                App.Conversations.save();

                Storage.storeMessage(message).then(callback);
            }
        }
    });

    /**
     * Integrates a tweet into the tweet list of the fiven timeline
     *
     * @function integrateIntoTimeline
     * @param {Tweet} tweet
     * @param {Timeline} timeline
     * @memberof GrapeTweet
     */
    this.integrateIntoTimeline= function(tweet, timeline){
        var self= this;
        return new $$.Promise(function(done){
            if(!self.active){
                self.active= true;
                self.integrate.apply(self, [tweet, timeline, done]);
                self.next();
            }else{
                self.queue.push([tweet, timeline, done]);
            }
        });
    }.bind({
        queue : [],
        active : false,
        integrate : function(tweet, timeline, callback){
            if (timeline.last != tweet.id_str) {
                tweet.last= timeline.last;
                tweet.next= null;

                timeline.last= tweet.id_str;
                if (tweet.last !== null) {
                    $$.Promise.all([
                        Storage.storeTweet(tweet, timeline),
                        Storage.getTweet(tweet.last, timeline.id),
                        App.Timelines.save()
                    ]).then(function(values){
                        var lastTweet= values[1];
                        lastTweet.next= tweet.id_str;
                        Storage.storeTweet(lastTweet, timeline).then(callback);
                    });
                } else {
                    $$.Promise.all([
                        Storage.storeTweet(tweet, timeline),
                        App.Timelines.save()
                    ]).then(callback);
                }

            } else {
                callback();
            }
        },
        next : function(){
            if(this.queue.length > 0){
                this.integrate.apply(this, this.queue.shift());
                this.next();
            }else{
                this.active= false;
            }
        }
    });

    /**
     * @class Timeline
     * @property {!string} namespace
     * @property {!string} id
     * @property {?Tweet} last
     */

    /**
     * Creates a new {Timeline}
     *
     * @function createTimeline
     * @param {string} name
     * @param {string} id
     * @returns {Timeline}
     * @memberof GrapeTweet
     */
    this.createTimeline= function(name, id){
        return {
            name : name,
            id : id,
            last : null
        };
    };

// 	check the current login
	Initializer.job('login', function(done){
        var spinner= $('dom').select('.splash .loading');

        if(!App.twitterSocket.isLoggedIn()){
            var button= $('dom').select('.splash .signIn');

			App.twitterSocket.requestToken('/oauth/request_token', 'http://grape-tweet.com/callback').then(function(){
                spinner.classList.add('hidden');
				$('dom').select('.splash .signIn').classList.remove('hidden');
			});

            button.addEventListener('click', function(){
				App.twitterSocket.authenticate('/oauth/authenticate');

                button.classList.add('hidden');
                spinner.classList.remove('hidden');

				$$.onOAuthCallback= function(data){
                    delete $$.onOAuthCallback;
                    $$.console.log(data);

					App.twitterSocket.verify('/oauth/access_token', data[1][1]).then(function(userId){
						App.Account.userId= userId;
                        App.Account.save();
						done();
					});
				};
			}, false);

        }else{

			$$.console.timeEnd('checkLogin');
			done();
		}

    }).depends('stores')

    .job('stores', function(done){
        var Store= Storage.Store;

		Storage.getStores().then(function(stores){
            Object.keys(Defaults).forEach(function(name){
                App[name]= new Store(App.objectReplace(Defaults[name], stores.find(function(item){
                    return item.name == name;
                })));
                App[name].save();
            });
        }).then(done);
    })

    .job('contacts', function(done){
        if(App.DataStatus.contacts.lastSync === ''){
            Net.syncContacts().then(done);
        } else {
			Net.syncContacts().then(UI.renderContacts);
            done();
        }
    }).depends('login')

    .job('directMessages', function(done){
        Storage.checkDirectMessages().then(function(directMessagesStored){
            if(!directMessagesStored){
                Net.downloadDirectMessages().then(done);
            }else{
                done();
            }
        });
    }).depends('login')

    .init().then(function(){
        var timeline = App.Timelines.record.$home;

        if(!timeline){
            App.Timelines.record.$home = timeline= App.createTimeline('Home', '$home');
            UI.renderTimeline(timeline);

            Net.fetchNewHomeTweets(timeline).then(function(){
                UI.renderTweets(timeline);
            });

            App.Timelines.save();

        }else{
            UI.renderTimeline(timeline);
            UI.renderTweets(timeline);
        }

        UI.renderChats();
        UI.renderContacts();
        App.updatePushServer();
        Bindings.ui();
        Bindings.systemMessages.apply($$);
        Bindings.navigation.apply($('hash'));
        $('hash').restore();

// 	    everything is done we can open the UI.
        $('dom').select('.client').classList.remove('right');
        $('dom').select('head meta[name="theme-color"]').setAttribute('content', '#2196f3');
        $('dom').select('.splash').transition('left').then(function(){
            $('dom').select('.splash .loading').classList.add('hidden');
            $('dom').select('.splash').classList.add('hidden');
            $$.console.timeEnd('start');
        });
    });
});
</pre>
	</article>
</section>





		</div>
	</div>

	<div class="clearfix"></div>

	

</div>
</div>


<footer>


	<span class="copyright">
	DocStrap Copyright © 2012-2014 The contributors to the JSDoc3 and DocStrap projects.
	</span>
	<br />

<span class="jsdoc-message">
	Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0-dev</a>
	on Sat Oct 31st 2015 using the <a
	href="https://github.com/terryweiss/docstrap">DocStrap template</a>.
</span>
</footer>

<!--<script src="scripts/sunlight.js"></script>-->
<script src="scripts/docstrap.lib.js"></script>
<script src="scripts/bootstrap-dropdown.js"></script>
<script src="scripts/toc.js"></script>

<script>
$( function () {
	$( "[id*='$']" ).each( function () {
		var $this = $( this );

		$this.attr( "id", $this.attr( "id" ).replace( "$", "__" ) );
	} );

	$( "#toc" ).toc( {
		anchorName  : function ( i, heading, prefix ) {
			return $( heading ).attr( "id" ) || ( prefix + i );
		},
		selectors   : "h1,h2,h3,h4",
		showAndHide : false,
		scrollTo    : "100px"
	} );

	$( "#toc>ul" ).addClass( "nav nav-pills nav-stacked" );
	$( "#main span[id^='toc']" ).addClass( "toc-shim" );
	$( '.dropdown-toggle' ).dropdown();
	//			$( ".tutorial-section pre, .readme-section pre" ).addClass( "sunlight-highlight-javascript" ).addClass( "linenums" );

	$( ".tutorial-section pre, .readme-section pre" ).each( function () {
		var $this = $( this );

		var example = $this.find( "code" );
		exampleText = example.html();
		var lang = /{@lang (.*?)}/.exec( exampleText );
		if ( lang && lang[1] ) {
			exampleText = exampleText.replace( lang[0], "" );
			example.html( exampleText );
			lang = lang[1];
		} else {
			lang = "javascript";
		}

		if ( lang ) {

			$this
			.addClass( "sunlight-highlight-" + lang )
			.addClass( "linenums" )
			.html( example.html() );

		}
	} );

	Sunlight.highlightAll( {
		lineNumbers : true,
		showMenu : true,
		enableDoclinks : true
	} );
} );
</script>



<!--Navigation and Symbol Display-->


<!--Google Analytics-->


</body>
</html>
